<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.chinaweal.sdcs.crcs.business.mapper.TasklistMapper">
    <resultMap id="BaseResultMap" type="com.chinaweal.sdcs.crcs.business.entity.Tasklist">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="caseguid" property="caseguid" jdbcType="VARCHAR"/>
        <result column="focus" property="focus" jdbcType="VARCHAR"/>
        <result column="serialnum" property="serialnum" jdbcType="VARCHAR"/>
        <result column="tserialnum" property="tserialnum" jdbcType="VARCHAR"/>
        <result column="rqsttitle" property="rqsttitle" jdbcType="VARCHAR"/>
        <result column="accordtype" property="accordtype" jdbcType="VARCHAR"/>
        <result column="labelname" property="labelname" jdbcType="VARCHAR"/>
        <result column="assigndate" property="assigndate" jdbcType="TIMESTAMP"/>
        <result column="expiredate" property="expiredate" jdbcType="TIMESTAMP"/>
        <result column="resulttimemin" property="resulttimemin" jdbcType="VARCHAR"/>
        <result column="systemsource" property="systemsource" jdbcType="VARCHAR"/>
        <result column="issignin" property="issignin" jdbcType="VARCHAR"/>
        <result column="signinaccount" property="signinaccount" jdbcType="VARCHAR"/>
        <result column="signinname" property="signinname" jdbcType="VARCHAR"/>
        <result column="signinuserid" property="signinuserid" jdbcType="VARCHAR"/>
        <result column="signindeptid" property="signindeptid" jdbcType="VARCHAR"/>
        <result column="signdate" property="signdate" jdbcType="TIMESTAMP"/>
        <result column="formtype" property="formtype" jdbcType="VARCHAR"/>
        <result column="operate" property="operate" jdbcType="VARCHAR"/>
        <result column="nextnodeid" property="nextnodeid" jdbcType="VARCHAR"/>
        <result column="state" property="state" jdbcType="VARCHAR"/>
        <result column="updatedate" property="updatedate" jdbcType="TIMESTAMP"/>
        <result column="fromnodeid" property="fromnodeid" jdbcType="VARCHAR"/>
        <result column="ismain" property="ismain" jdbcType="VARCHAR"/>
        <result column="isaccept" property="isaccept" jdbcType="VARCHAR"/>
        <result column="senderid" property="senderid" jdbcType="VARCHAR"/>
        <result column="sdexpirationdate" property="sdexpirationdate" jdbcType="TIMESTAMP"/>
        <result column="worktype" property="worktype" jdbcType="VARCHAR"/>
        <result column="regionid" property="regionid" jdbcType="VARCHAR"/>
        <result column="bustype" property="bustype" jdbcType="VARCHAR"/>
        <result column="complainant" property="complainant" jdbcType="VARCHAR"/>
        <result column="complainanted" property="complainanted" jdbcType="VARCHAR"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="address" property="address" jdbcType="VARCHAR"/>
        <result column="content" property="content" jdbcType="VARCHAR"/>
        <result column="results" property="results" jdbcType="VARCHAR"/>
        <result column="classification" property="classification" jdbcType="VARCHAR"/>
        <result column="handleregion" property="handleregion" jdbcType="VARCHAR"/>
        <result column="handledeptid" property="handledeptid" jdbcType="VARCHAR"/>
        <result column="handledeptname" property="handledeptname" jdbcType="VARCHAR"/>
        <result column="regdeptname" property="regdeptname" jdbcType="VARCHAR"/>
        <result column="registrant" property="registrant" jdbcType="VARCHAR"/>
        <result column="cwcs" property="cwcs" jdbcType="VARCHAR"/>
        <result column="dubcs" property="dubcs" jdbcType="VARCHAR"/>
        <result column="firstblqx" property="firstblqx" jdbcType="TIMESTAMP"/>
        <result column="blqx" property="blqx" jdbcType="TIMESTAMP"/>
        <result column="handleorgname" property="handleorgname" jdbcType="VARCHAR"/>
        <result column="isregistercase" property="isregistercase" jdbcType="VARCHAR"/>
        <result column="taskstartdate" property="taskstartdate" jdbcType="TIMESTAMP"/>
        <result column="taskenddate" property="taskenddate" jdbcType="TIMESTAMP"/>
        <result column="createdate" property="createdate" jdbcType="TIMESTAMP"/>
        <result column="filingdate" property="filingdate" jdbcType="TIMESTAMP"/>
        <result column="iscp" property="iscp" jdbcType="VARCHAR"/>
        <result column="isnewassign" property="isnewassign" jdbcType="VARCHAR"/>
        <result column="iscbdf" property="iscbdf" jdbcType="VARCHAR"/>
        <!--<result column="appealsource" property="appealsource" jdbcType="VARCHAR"/>-->
        <result column="objectcategory" property="objectcategory" jdbcType="VARCHAR"/>
        <result column="servicetype" property="servicetype" jdbcType="VARCHAR"/>
        <result column="complaintstype" property="complaintstype" jdbcType="VARCHAR"/>
        <result column="feedback" property="feedback" jdbcType="VARCHAR"/>
    </resultMap>
    <sql id="Base_Column_List">
        id, caseguid, focus,
        serialnum, tserialnum, rqsttitle,
        accordtype, labelname, assigndate,
        expiredate, resulttimemin, systemsource,
        issignin, signinaccount, signinname,
        signinuserid, signindeptid, signdate, formtype,
        operate, nextnodeid, state, ismain,
        fromnodeid, isaccept, senderid, updatedate,
        sdexpirationdate,worktype, regionid, bustype,complainant,
        complainanted,phone,address,content,results,classification,
        handleregion, handledeptid,handledeptname,regdeptname,registrant,
        cwcs, dubcs, firstblqx,blqx, handleorgname,isregistercase, taskstartdate, taskenddate,
        createdate,filingdate,iscp,isnewassign,iscbdf,appealsource,objectcategory,servicetype,complaintstype，
        feedback
    </sql>

    <!--业务待办查询-->
    <select id="searchTasklist" resultMap="BaseResultMap">
        select
        t.id,t.caseguid,t.focus,t.serialnum,t.tserialnum,t.rqsttitle,t.accordtype,t.labelname,t.assigndate,t.expiredate,t.resulttimemin,t.systemsource,
        t.issignin,t.signinaccount,t.signinname,t.signinuserid,t.signindeptid,t.signdate,t.formtype,t.operate,t.nextnodeid,t.state,t.updatedate,
        t.ismain,t.isaccept,t.senderid,t.sdexpirationdate,t.worktype,t.handledeptname,t.regdeptname,t.registrant,t.cwcs,
        t.dubcs, t.firstblqx,blqx, t.bustype, t.complainant,
        t.complainanted, t.content, t.handleorgname,t.isregistercase
        from (
        select
        a.id,a.caseguid,a.focus,a.serialnum,a.tserialnum,a.rqsttitle,a.accordtype,a.labelname,a.assigndate,a.expiredate,a.resulttimemin,a.systemsource,
        a.issignin,a.signinaccount,a.signinname,a.signinuserid,a.signindeptid,a.signdate,a.formtype,a.operate,a.nextnodeid,a.state,a.updatedate,
        b.ismain as ismain,a.isaccept,a.senderid,a.sdexpirationdate,a.worktype,'' as keyword,d.linkphonenumber as
        tel,c.username,a.handledeptname,a.regdeptname,a.registrant,a.cwcs, a.dubcs, a.firstblqx, a.bustype,
        a.complainant,a.isnewassign,
        a.complainanted, d.rqstcontent as content, a.blqx, a.handleorgname,a.isregistercase,d.name as rqstperson, '' as
        subjectname
        from tasklist a
        inner join commomform d on d.caseguid=a.caseguid
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        union all
        select
        a.id,a.caseguid,a.focus,a.serialnum,a.tserialnum,a.rqsttitle,a.accordtype,a.labelname,a.assigndate,a.expiredate,a.resulttimemin,a.systemsource,
        a.issignin,a.signinaccount,a.signinname,a.signinuserid,a.signindeptid,a.signdate,a.formtype,a.operate,a.nextnodeid,a.state,a.updatedate,
        b.ismain as ismain,a.isaccept,a.senderid,a.sdexpirationdate,a.worktype,'' as keyword, d.linknumber as
        tel,c.username,a.handledeptname,a.regdeptname,a.registrant,a.cwcs, a.dubcs, a.firstblqx, a.bustype,
        a.complainant,a.isnewassign,
        a.complainanted, d.rqstcontent as content, a.blqx, a.handleorgname,a.isregistercase,d.name as rqstperson,'' as
        subjectname
        from tasklist a
        inner join consultationform d on d.caseguid=a.caseguid
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        union all
        select
        a.id,a.caseguid,a.focus,a.serialnum,a.tserialnum,a.rqsttitle,a.accordtype,a.labelname,a.assigndate,a.expiredate,a.resulttimemin,a.systemsource,
        a.issignin,a.signinaccount,a.signinname,a.signinuserid,a.signindeptid,a.signdate,a.formtype,a.operate,a.nextnodeid,a.state,a.updatedate,
        b.ismain as ismain,a.isaccept,a.senderid,a.sdexpirationdate,a.worktype,d.keyword as keyword,d.linknumber as
        tel,c.username,a.handledeptname,a.regdeptname,a.registrant,a.cwcs, a.dubcs, a.firstblqx, a.bustype,
        a.complainant,a.isnewassign,
        a.complainanted, d.problemdescribe as content, a.blqx, a.handleorgname,a.isregistercase,d.rqstperson as
        rqstperson,d.subjectname as subjectname
        from tasklist a
        inner join economyform d on d.caseguid=a.caseguid
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        union all
        select
        a.id,a.caseguid,a.focus,a.serialnum,a.tserialnum,a.rqsttitle,a.accordtype,a.labelname,a.assigndate,a.expiredate,a.resulttimemin,a.systemsource,
        a.issignin,a.signinaccount,a.signinname,a.signinuserid,a.signindeptid,a.signdate,a.formtype,a.operate,a.nextnodeid,a.state,a.updatedate,
        b.ismain as ismain,a.isaccept,a.senderid,a.sdexpirationdate,a.worktype, d.keyword as keyword,d.linknumber as
        tel,c.username,a.handledeptname,a.regdeptname,a.registrant,a.cwcs, a.dubcs, a.firstblqx, a.bustype,
        a.complainant,a.isnewassign,
        a.complainanted, d.problemdescribe as content, a.blqx, a.handleorgname,a.isregistercase,d.rqstperson as
        rqstperson,d.subjectname as subjectname
        from tasklist a
        inner join complaintform d on d.caseguid=a.caseguid
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        )t
        <where>
            nextnodeid != 'end'
            <if test="aicUser != null">
                and t.username = #{aicUser.ename}
            </if>
            <if test="map != null">
                <if test="map.currentLink != null and map.currentLink !=''">
                    and t.nextnodeid = #{map.currentLink}
                </if>
                <if test="map.formType != null and map.formType !=''">
                    and t.formtype = #{map.formType}
                </if>
                <if test="map.tserialnum != null and map.tserialnum !=''">
                    and t.tserialnum like '%' || #{map.tserialnum} || '%'
                </if>
                <if test="map.rqsttitle != null and map.rqsttitle !=''">
                    and t.rqsttitle like '%' || #{map.rqsttitle} || '%'
                </if>
                <if test="map.serialnum != null and map.serialnum !=''">
                    and t.serialnum like '%' || #{map.serialnum} || '%'
                </if>
                <choose>
                    <when test="map.systemsource == '01' ||map.systemsource == '02'">
                        <if test="map.beComplainant != null and map.beComplainant !=''">
                            and t.subjectname like '%' || #{map.beComplainant} || '%'
                        </if>
                        <if test="map.complainant != null and map.complainant !=''">
                            and t.rqstperson like '%' || #{map.complainant} || '%'
                        </if>
                    </when>
                    <when test="map.systemsource == '03'">
                        <if test="map.beComplainant != null and map.beComplainant !=''">
                            and t.complainanted like '%' || #{map.beComplainant} || '%'
                        </if>
                        <if test="map.complainant != null and map.complainant !=''">
                            and t.complainant like '%' || #{map.complainant} || '%'
                        </if>
                    </when>
                </choose>
                <if test="map.systemsource != null and map.systemsource !=''">
                    <choose>
                        <when test="map.systemsource == '0203'">
                            AND (t.systemsource = '02' OR t.systemsource = '03')
                            <![CDATA[ AND t.sdexpirationdate >= to_timestamp(#{map.expectedBegin}, 'yyyy-MM-dd hh24:mi:ss')]]>
                            <![CDATA[ AND t.sdexpirationdate <= to_timestamp(#{map.expectedEnd}, 'yyyy-MM-dd hh24:mi:ss')]]>
                        </when>
                        <otherwise>
                            and t.systemsource = #{map.systemsource}
                        </otherwise>
                    </choose>
                </if>
                <if test="map.operate != null and map.operate !=''">
                    and t.operate = #{map.operate}
                </if>
                <if test="map.focus != null and map.focus !=''">
                    and t.focus = #{map.focus}
                </if>
                <if test="map.nextnodeid!= null and map.nextnodeid !=''">
                    and t.nextnodeid = #{map.nextnodeid}
                </if>
                <if test="map.tel!= null and map.tel !=''">
                    and t.tel like '%' || #{map.tel} || '%'
                </if>
                <if test="map.keyword!= null and map.keyword !=''">
                    and t.keyword like '%' || #{map.keyword} || '%'
                </if>
                <if test="map.begindate != null and map.begindate !=''">
                    <![CDATA[ and t.assigndate  >=  to_timestamp(#{map.begindate}, 'yyyy-MM-dd hh24:mi:ss')]]>
                </if>
                <if test="map.enddate != null and map.enddate !=''">
                    <![CDATA[ and t.assigndate <= to_timestamp(#{map.enddate}, 'yyyy-MM-dd hh24:mi:ss')]]>
                </if>
                <if test="map.isnewassign!= null and map.isnewassign !=''">
                    and t.isnewassign = #{map.isnewassign}
                </if>
                <choose>
                    <when test="map.sortField =='sdexpirationdate'">
                        order by sdexpirationdate
                        <if test="map.sortOrder =='desc'">
                            desc
                        </if>
                    </when>
                    <when test="map.sortField =='assigndate'">
                        order by assigndate
                        <if test="map.sortOrder =='desc'">
                            desc
                        </if>
                    </when>
                    <otherwise>
                        order by sdexpirationdate
                    </otherwise>
                </choose>
            </if>
        </where>

    </select>

    <select id="selectTasklist" resultMap="BaseResultMap">
        select
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        b.ismain as ismain,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype
        from tasklist a
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        <if test="aicUser != null">
            and c.username = #{aicUser.ename}
        </if>
        order by a.signdate
    </select>

    <!--首页数据统计查询-->
    <select id="selectTasklistCount" resultType="java.lang.Integer">
        select
        count(*)
        from (
        select c.username, a.systemsource, a.sdexpirationdate,a.isnewassign,a.feedback,a.isregistercase,a.formtype from tasklist a
        inner join commomform d on d.caseguid=a.caseguid
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        union all
        select c.username, a.systemsource, a.sdexpirationdate,a.isnewassign,a.feedback,a.isregistercase,a.formtype from tasklist a
        inner join consultationform d on d.caseguid=a.caseguid
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        union all
        select c.username, a.systemsource, a.sdexpirationdate,a.isnewassign,a.feedback,a.isregistercase,a.formtype from tasklist a
        inner join economyform d on d.caseguid=a.caseguid
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        union all
        select c.username, a.systemsource, a.sdexpirationdate,a.isnewassign,a.feedback,a.isregistercase,a.formtype from tasklist a
        inner join complaintform d on d.caseguid=a.caseguid
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_users c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and (a.isSignIn = '0' or a.issignin = null or a.signinaccount = null or
        (a.issignin = '1' and a.signinaccount = c.username))
        ) t
        where t.username = #{ename}
        <choose>
            <when test="systemsource != null and systemsource != ''">
                AND t.systemsource = #{systemsource}
            </when>
            <when test="isnewassign != null and isnewassign != ''">
                AND t.isnewassign = #{isnewassign}
            </when>
            <when test="sldjbegin != null and sldjbegin != ''">
                AND t.systemsource ='01' AND t.isregistercase is null AND t.formtype='03'
                <![CDATA[ AND t.sdexpirationdate >= to_timestamp(#{sldjbegin}, 'yyyy-MM-dd hh24:mi:ss')]]>
                <![CDATA[ AND t.sdexpirationdate <= to_timestamp(#{sldjend}, 'yyyy-MM-dd hh24:mi:ss')]]>
            </when>
            <when test="feedbackbegin != null and feedbackbegin != ''">
                AND t.systemsource ='01' AND t.feedback is null AND t.formtype!='01'
                <![CDATA[ AND t.sdexpirationdate >= to_timestamp(#{feedbackbegin}, 'yyyy-MM-dd hh24:mi:ss')]]>
                <![CDATA[ AND t.sdexpirationdate <= to_timestamp(#{feedbackend}, 'yyyy-MM-dd hh24:mi:ss')]]>
            </when>
            <otherwise>
                AND (t.systemsource = '02' OR t.systemsource = '03')
                <![CDATA[ AND t.sdexpirationdate >= to_timestamp(#{expectedBegin}, 'yyyy-MM-dd hh24:mi:ss')]]>
                <![CDATA[ AND t.sdexpirationdate <= to_timestamp(#{expectedEnd}, 'yyyy-MM-dd hh24:mi:ss')]]>
            </otherwise>
        </choose>
    </select>

    <!-- 综合查询-->
    <select id="searchBusinessInfo" resultMap="BaseResultMap">
        select t.id, t.caseguid, t.focus, t.serialnum, t.tserialnum, t.rqsttitle, t.accordtype,
        t.labelname, t.assigndate, t.expiredate, t.systemsource, t.formtype, t.bustype, t.contents, t.handleopinion,
        t.complainant,t.complainanted,t.phone,t.address,t.content,t.results,t.classification,applealtocase, operate,
        jyareacode,
        financialloss, doublemoney
        from
        (select
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.systemsource,
        a.formtype,
        a.bustype,
        b.isweb as buyInInternet,
        b.rqstperson as serialName,
        b.rqstnumber as serialTel,
        b.rqstaddress as serialAddress,
        b.appealsource as appealsource,
        b.businesstype as businesstype,
        b.subjectname as subjectname,
        b.objclassify as objectcategory,
        b.brand as brand,
        b.servicetype as servicetype,
        c.resultsofmediation as resultsofmediation,
        b.region as region,
        b.keyword as keyword,
        b.contentrs as contents,
        c.handleopinion,
        a.handleregion,
        a.handledeptid,
        b.rqstperson as complainant,
        b.subjectname as complainanted,
        b.subjectphone as phone,
        b.subjectaddress as address,
        b.problemdescribe as content,
        c.handleopinion as results,
        b.entitytype as classification,
        c.applealtocase as applealtocase,
        a.operate as operate,
        b.jyareacode as jyareacode,
        c.financialloss as financialloss,
        c.doublemoney as doublemoney,
        from tasklist a
        inner join complaintform b on a.caseguid = b.caseguid
        left join caseprocesform c on a.caseguid = c.caseguid
        union all
        select
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.systemsource,
        a.formtype,
        a.bustype,
        '0' as buyInInternet,
        b.name as serialName,
        b.linkphonenumber as serialTel,
        '' as serialAddress,
        '' as appealsource,
        '' as businesstype,
        b.entname as subjectname,
        '' as objectcategory,
        '' as brand,
        '' as servicetype,
        c.resultsofmediation as resultsofmediation,
        b.region as region,
        '' as keyword,
        b.rqstcontent as contents,
        c.handleopinion,
        a.handleregion,
        a.handledeptid,
        b.name as complainant,
        '' as complainanted,
        b.rqstphonenumber as phone,
        b.address as address,
        b.rqstcontent as content,
        c.handleopinion as results,
        b.usertype as classification,
        c.applealtocase as applealtocase,
        a.operate as operate,
        b.region as jyareacode,
        c.financialloss as financialloss,
        c.doublemoney as doublemoney,
        from tasklist a
        inner join commomform b on a.caseguid = b.caseguid
        left join caseprocesform c on a.caseguid = c.caseguid
        union all
        select
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.systemsource,
        a.formtype,
        a.bustype,
        b.isweb as buyInInternet,
        b.rqstperson as serialName,
        b.rqstnumber as serialTel,
        b.rqstaddress as serialAddress,
        b.appealsource as appealsource,
        b.businesstype as businesstype,
        b.subjectname as subjectname,
        b.objclassify as objectcategory,
        b.brand as brand,
        b.objname as servicetype,
        c.resultsofmediation as resultsofmediation,
        b.region as region,
        b.keyword as keyword,
        b.problemdescribe as contents,
        c.handleopinion,
        a.handleregion,
        a.handledeptid,
        b.rqstperson as complainant,
        b.subjectname as complainanted,
        b.reportedcontactnumber as phone,
        b.subjectaddress as address,
        b.problemdescribe as content,
        c.handleopinion as results,
        b.objectcategory as classification,
        c.applealtocase as applealtocase,
        a.operate as operate,
        b.jyareacode as jyareacode,
        c.financialloss as financialloss,
        c.doublemoney as doublemoney,
        from tasklist a
        inner join economyform b on a.caseguid = b.caseguid
        left join caseprocesform c on a.caseguid = c.caseguid
        union all
        select
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.systemsource,
        a.formtype,
        a.bustype,
        '0' as buyInInternet,
        b.name as serialName,
        b.linknumber as serialTel,
        b.address as serialAddress,
        b.appealsource as appealsource,
        b.businesstype as businesstype,
        '' as subjectname,
        '' as objectcategory,
        '' as brand,
        '' as servicetype,
        c.resultsofmediation as resultsofmediation,
        b.region as region,
        '' as keyword,
        b.rqstcontent as contents,
        c.handleopinion,
        a.handleregion,
        a.handledeptid,
        b.name as complainant,
        '' as complainanted,
        b.rqstnumber as phone,
        b.address as address,
        b.rqstcontent as content,
        c.handleopinion as results,
        b.category as classification,
        c.applealtocase as applealtocase,
        a.operate as operate,
        b.jyareacode as jyareacode,
        c.financialloss as financialloss,
        c.doublemoney as doublemoney,
        from tasklist a
        inner join consultationform b on a.caseguid = b.caseguid
        left join caseprocesform c on a.caseguid = c.caseguid
        ) t
        <where>
            <if test="map != null">
                <if test="map.focus != null and map.focus !=''">
                    and t.focus = #{map.focus}
                </if>
                <if test="map.serialnum != null and map.serialnum !=''">
                    and t.serialnum like '%' || #{map.serialnum} || '%'
                </if>
                <if test="map.tserialnum != null and map.tserialnum !=''">
                    and t.tserialnum like '%' || #{map.tserialnum} || '%'
                </if>
                <if test="map.rqsttitle != null and map.rqsttitle !=''">
                    and t.rqsttitle like '%' || #{map.rqsttitle} || '%'
                </if>
                <if test="map.createdate != null and map.createdate !=''">
                    <![CDATA[ and t.assigndate  >=  to_timestamp(#{map.createdate}, 'yyyy-MM-dd hh24:mi:ss')]]>
                </if>
                <if test="map.duetime != null and map.duetime !=''">
                    <![CDATA[ and t.assigndate <= to_timestamp(#{map.duetime}, 'yyyy-MM-dd hh24:mi:ss')]]>
                </if>
                <if test="map.buyInInternet != null and map.buyInInternet !=''">
                    and t.isweb = #{map.buyInInternet}
                </if>
                <if test="map.serialName != null and map.serialName !=''">
                    and t.serialName like '%' || #{map.serialName} || '%'
                </if>
                <if test="map.serialTel != null and map.serialTel !=''">
                    and t.serialTel like '%' || #{map.serialTel} || '%'
                </if>
                <if test="map.serialAddress != null and map.serialAddress !=''">
                    and t.serialAddress like '%' || #{map.serialAddress} || '%'
                </if>
                <if test="map.appealsource != null and map.appealsource !=''">
                    and t.appealsource like '%' || #{map.appealsource} || '%'
                </if>
                <if test="map.businesstype != null and map.businesstype !=''">
                    and t.businesstype = #{map.businesstype}
                </if>
                <if test="map.subjectname != null and map.subjectname !=''">
                    and t.subjectname like '%' || #{map.subjectname} || '%'
                </if>
                <if test="map.objectcategory != null and map.objectcategory !=''">
                    and t.objectcategory = #{map.objectcategory}
                </if>
                <if test="map.brand != null and map.brand !=''">
                    and t.brand = #{map.brand}
                </if>
                <if test="map.keyword != null and map.keyword !=''">
                    and t.keyword = #{map.keyword}
                </if>
                <if test="map.bustype != null and map.bustype !=''">
                    and t.bustype = #{map.bustype}
                </if>
                <if test="map.content != null and map.content !=''">
                    and t.contents like '%' || #{map.content} || '%'
                </if>
                <if test="map.handleopinion != null and map.handleopinion !=''">
                    and t.handleopinion like '%' || #{map.handleopinion} || '%'
                </if>
                <if test="map.systemsource != null and map.systemsource !=''">
                    and t.systemsource = #{map.systemsource}
                </if>
                <if test="map.servicetype != null and map.servicetype !=''">
                    and t.servicetype like '%' || #{map.servicetype} || '%'
                </if>
                <if test="map.handleregion != null and map.handleregion !=''">
                    and t.handleregion = #{map.handleregion}
                </if>
                <if test="map.handledeptid != null and map.handledeptid !=''">
                    and t.handledeptid = #{map.handledeptid}
                </if>
                <if test="map.applealtocase != null and map.applealtocase !=''">
                    and t.applealtocase = #{map.applealtocase}
                </if>
            </if>
        </where>
    </select>

    <!--首页已办数据统计查询-->
    <select id="searchFinishListCount" resultType="java.lang.Integer">
        select
            count(*)
        from (
                select a.*
                from tasklist a
                inner join commomform d on d.caseguid=a.caseguid
                where exists(select 1 from processinfo e where e.caseguid=a.caseguid and ismain='1' and status='1' and handleruserid=#{userid})
                and not exists (select 1 from processinfo e where e.caseguid=a.caseguid and ismain='1' and status='0' and handleruserid=#{userid})
                union all
                select a.*
                from tasklist a
                inner join complaintform d on d.caseguid=a.caseguid
                where exists(select 1 from processinfo e where e.caseguid=a.caseguid and ismain='1' and status='1' and handleruserid=#{userid})
                and not exists (select 1 from processinfo e where e.caseguid=a.caseguid and ismain='1' and status='0' and handleruserid=#{userid})
                union all
                select a.*
                from tasklist a
                inner join economyform d on d.caseguid=a.caseguid
                where exists(select 1 from processinfo e where e.caseguid=a.caseguid and ismain='1' and status='1' and handleruserid=#{userid})
                and not exists (select 1 from processinfo e where e.caseguid=a.caseguid
                and ismain='1' and status='0' and handleruserid=#{userid})
                union all
                select a.*
                from tasklist a
                inner join consultationform d on d.caseguid=a.caseguid
                where exists(select 1 from processinfo e where e.caseguid=a.caseguid and ismain='1' and status='1' and handleruserid=#{userid})
                and not exists (select 1 from processinfo e where e.caseguid=a.caseguid and ismain='1' and status='0' and handleruserid=#{userid})
        ) t
        where t.systemsource = #{systemsource}  and t.state='0'
    </select>

    <!--工单已办列表查询-->
    <select id="searchFinishListData" resultMap="BaseResultMap">
        SELECT
        t.id,
        t.caseguid,
        t.focus,
        t.serialnum,
        t.tserialnum,
        t.rqsttitle,
        t.accordtype,
        t.labelname,
        t.assigndate,
        t.expiredate,
        t.resulttimemin,
        t.systemsource,
        t.issignin,
        t.signinaccount,
        t.signinname,
        t.signinuserid,
        t.signindeptid,
        t.signdate,
        t.formtype,
        t.operate,
        t.nextnodeid,
        t.state,
        t.updatedate,
        t.isaccept,
        t.senderid,
        t.sdexpirationdate,
        t.worktype,
        t.handledeptname,
        t.regdeptname,
        t.registrant,
        t.cwcs,
        t.dubcs,
        t.firstblqx,
        blqx,
        t.bustype,
        t.complainant,
        t.isregistercase,
        t.appealsource,
        t.complainanted,
        t.content,
        t.servicetype,
        t.complaintstype,
        t.rqstperson,
        t.isweb,
        t.isprofessional,
        t.incomingcommpany,
        t.feedback
        FROM
        (
        SELECT
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype,
        '' AS keyword,
        d.linkphonenumber AS tel,
        a.handledeptname,
        a.regdeptname,
        a.registrant,
        a.cwcs,
        a.dubcs,
        a.firstblqx,
        a.blqx,
        a.bustype,
        a.complainant,
        a.isregistercase,
        d.appealsource,
        a.complainanted,
        d.rqstcontent AS content,
        '无' AS servicetype,
        d.complaintstype,
        d.NAME AS rqstperson,
        '无' AS isweb,
        d.isprofessional,
        d.incomingcommpany,
        a.feedback
        FROM
        tasklist a
        INNER JOIN commomform d ON d.caseguid = a.caseguid
        WHERE
        EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '1'
        AND handleruserid = #{userid})

        AND NOT EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '0'
        AND handleruserid = #{userid})
        UNION ALL
        SELECT
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype,
        '' AS keyword,
        d.linknumber AS tel,
        a.handledeptname,
        a.regdeptname,
        a.registrant,
        a.cwcs,
        a.dubcs,
        a.firstblqx,
        a.blqx,
        a.bustype,
        a.complainant,
        a.isregistercase,
        d.appealsource,
        a.complainanted,
        d.rqstcontent AS content,
        '无' AS servicetype,
        d.complaintstype,
        d.NAME AS rqstperson,
        '无' AS isweb,
        d.isprofessional,
        d.incomingcommpany,
        a.feedback
        FROM
        tasklist a
        INNER JOIN consultationform d ON d.caseguid = a.caseguid
        WHERE
        EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '1'
        AND handleruserid = #{userid})

        AND NOT EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '0'
        AND handleruserid = #{userid})
        UNION ALL
        SELECT
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype,
        d.keyword AS keyword,
        d.linknumber AS tel,
        a.handledeptname,
        a.regdeptname,
        a.registrant,
        a.cwcs,
        a.dubcs,
        a.firstblqx,
        a.blqx,
        a.bustype,
        a.complainant,
        a.isregistercase,
        d.appealsource,
        a.complainanted,
        d.problemdescribe AS content,
        d.objectcategory AS servicetype,
        d.reportprovidelb AS complaintstype,
        d.rqstperson,
        d.isweb,
        d.isprofessional,
        d.incomingcommpany,
        a.feedback
        FROM
        tasklist a
        INNER JOIN economyform d ON d.caseguid = a.caseguid
        WHERE
        EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '1'
        AND handleruserid = #{userid})

        AND NOT EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '0'
        AND handleruserid = #{userid})
        UNION ALL
        SELECT
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype,
        d.keyword AS keyword,
        d.linknumber AS tel,
        a.handledeptname,
        a.regdeptname,
        a.registrant,
        a.cwcs,
        a.dubcs,
        a.firstblqx,
        a.blqx,
        a.bustype,
        a.complainant,
        a.isregistercase,
        d.appealsource,
        a.complainanted,
        d.problemdescribe AS content,
        d.servicetype,
        d.complaintstype,
        d.rqstperson,
        d.isweb,
        d.isprofessional,
        d.incomingcommpany,
        a.feedback
        FROM
        tasklist a
        INNER JOIN complaintform d ON d.caseguid = a.caseguid
        WHERE
        EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '1'
        AND handleruserid = #{userid})

        AND NOT EXISTS ( SELECT 1 FROM processinfo e WHERE e.caseguid = a.caseguid AND ismain = '1' AND STATUS = '0' AND handleruserid = #{userid})
        ) t
        <where>
            t.state = '0'
            <if test="map != null">
                <if test="map.currentLink != null and map.currentLink !=''">
                    and t.nextnodeid = #{map.currentLink}
                </if>
                <if test="map.tserialnum != null and map.tserialnum !=''">
                    and t.tserialnum like '%' || #{map.tserialnum} || '%'
                </if>
                <if test="map.rqsttitle != null and map.rqsttitle !=''">
                    and t.rqsttitle like '%' || #{map.rqsttitle} || '%'
                </if>
                <if test="map.serialnum != null and map.serialnum !=''">
                    and t.serialnum like '%' || #{map.serialnum} || '%'
                </if>
                <if test="map.systemsource != null and map.systemsource !=''">
                    and t.systemsource = #{map.systemsource}
                </if>
                <if test="map.operate != null and map.operate !=''">
                    and t.operate = #{map.operate}
                </if>
                <if test="map.bustype != null and map.bustype !=''">
                    and t.bustype like '%' || #{map.bustype} || '%'
                </if>
                <if test="map.focus != null and map.focus !=''">
                    and t.focus = #{map.focus}
                </if>
                <if test="map.nextnodeid!= null and map.nextnodeid !=''">
                    and t.nextnodeid = #{map.nextnodeid}
                </if>
                <if test="map.tel!= null and map.tel !=''">
                    and t.tel like '%' || #{map.tel} || '%'
                </if>
                <if test="map.keyword!= null and map.keyword !=''">
                    and t.keyword like '%' || #{map.keyword} || '%'
                </if>
                <if test="map.begindate != null and map.begindate !=''">
                    <![CDATA[ and t.assigndate  >=  to_timestamp(#{map.begindate}, 'yyyy-MM-dd hh24:mi:ss')]]>
                </if>
                <if test="map.enddate != null and map.enddate !=''">
                    <![CDATA[ and t.assigndate <= to_timestamp(#{map.enddate}, 'yyyy-MM-dd hh24:mi:ss')]]>
                </if>
                <if test="map.sortField =='assigndate'">
                    order by assigndate
                    <if test="map.sortOrder =='desc'">
                        desc
                    </if>
                </if>
                <if test="map.sortField =='sdexpirationdate'">
                    order by sdexpirationdate
                    <if test="map.sortOrder =='desc'">
                        desc
                    </if>
                </if>
                <if test="map.rqstperson!= null and map.rqstperson !=''">
                    and t.rqstperson like '%' || #{map.rqstperson} || '%'
                </if>
                <if test="map.handledeptname!= null and map.handledeptname !=''">
                    and t.handledeptname like '%' || #{map.handledeptname} || '%'
                </if>
                <if test="map.complaintstype!= null and map.complaintstype !=''">
                    and t.complaintstype like '%' || #{map.complaintstype} || '%'
                </if>
                <if test="map.servicetype!= null and map.servicetype !=''">
                    and t.servicetype like '%' || #{map.servicetype} || '%'
                </if>
                <if test="map.isregistercase!= null and map.isregistercase !=''">
                    and t.isregistercase=#{map.isregistercase}
                </if>
                <if test="map.isweb!= null and map.isweb !=''">
                    and t.isweb = #{map.isweb}
                </if>
                <if test="map.isprofessional !=null and map.isprofessional !=''">
                    and t.isprofessional=#{map.isprofessional}
                </if>
                <if test="map.appealsource!= null and map.appealsource !=''">
                    and t.appealsource like '%' || #{map.appealsource} || '%'
                </if>
                <if test="map.incomingcommpany!= null and map.incomingcommpany !=''">
                    and t.incomingcommpany like '%' || #{map.incomingcommpany} || '%'
                </if>
            </if>
        </where>
        ORDER BY t.assigndate DESC
    </select>



    <!--短信 修改为2个小时前提醒-->
    <select id="messageList" resultType="com.chinaweal.sdcs.crcs.business.entity.UsersApp">
        select
        a.caseguid,
        a.formtype,
        a.bustype,
        a.sdexpirationdate,
        c.mobile,
        c.userid,
        c.worktype,
        c.gender,
        a.serialnum,
	    a.rqsttitle,
	    a.systemsource
        from tasklist a
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_usersapp c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0' and b.ismain='1' and age(sdexpirationdate,now())&lt;INTERVAL '2 hour' and sdexpirationdate&gt;now()
    </select>
    <select id="twoMessage" resultType="com.chinaweal.sdcs.crcs.business.entity.UsersApp">
        select
        a.caseguid,
        a.formtype,
        a.bustype,
        a.sdexpirationdate,
        c.mobile,
        c.userid,
        c.worktype,
        c.gender
        from tasklist a
        left join processinfo b on a.caseguid = b.caseguid
        inner join t_usersapp c on b.handleruserid = c.userid
        where a.state ='0' and b.status = '0'  and age(sdexpirationdate,now())&lt;INTERVAL '1 hour' and age(sdexpirationdate,now())&gt;INTERVAL '0.5 hour'
    </select>


    <select id="selectBusinessdeptNull" parameterType="java.util.List" resultMap="BaseResultMap">
        select * from tasklist
        <where>
            handleregion is null and createdate >'2019-12-01'
        </where>
         ORDER BY createdate desc
    </select>

    <!--受理登记已办预警提醒-->
    <select id="selectWarningCount" resultType="java.lang.Integer">
        SELECT
       count (*)
        FROM
        (
        SELECT
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype,
        '' AS keyword,
        d.linkphonenumber AS tel,
        a.handledeptname,
        a.regdeptname,
        a.registrant,
        a.cwcs,
        a.dubcs,
        a.firstblqx,
        a.blqx,
        a.bustype,
        a.complainant,
        a.isregistercase,
        d.appealsource,
        a.complainanted,
        d.rqstcontent AS content,
        '无' AS servicetype,
        d.complaintstype,
        d.NAME AS rqstperson,
        '无' AS isweb,
        d.isprofessional,
        d.incomingcommpany,
        a.feedback
        FROM
        tasklist a
        INNER JOIN commomform d ON d.caseguid = a.caseguid
        WHERE
        EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '1'
        AND handleruserid = #{userid})

        AND NOT EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '0'
        AND handleruserid = #{userid})
        UNION ALL
        SELECT
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype,
        '' AS keyword,
        d.linknumber AS tel,
        a.handledeptname,
        a.regdeptname,
        a.registrant,
        a.cwcs,
        a.dubcs,
        a.firstblqx,
        a.blqx,
        a.bustype,
        a.complainant,
        a.isregistercase,
        d.appealsource,
        a.complainanted,
        d.rqstcontent AS content,
        '无' AS servicetype,
        d.complaintstype,
        d.NAME AS rqstperson,
        '无' AS isweb,
        d.isprofessional,
        d.incomingcommpany,
        a.feedback
        FROM
        tasklist a
        INNER JOIN consultationform d ON d.caseguid = a.caseguid
        WHERE
        EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '1'
        AND handleruserid = #{userid})

        AND NOT EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '0'
        AND handleruserid = #{userid})
        UNION ALL
        SELECT
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype,
        d.keyword AS keyword,
        d.linknumber AS tel,
        a.handledeptname,
        a.regdeptname,
        a.registrant,
        a.cwcs,
        a.dubcs,
        a.firstblqx,
        a.blqx,
        a.bustype,
        a.complainant,
        a.isregistercase,
        d.appealsource,
        a.complainanted,
        d.problemdescribe AS content,
        d.objectcategory AS servicetype,
        d.reportprovidelb AS complaintstype,
        d.rqstperson,
        d.isweb,
        d.isprofessional,
        d.incomingcommpany,
        a.feedback
        FROM
        tasklist a
        INNER JOIN economyform d ON d.caseguid = a.caseguid
        WHERE
        EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '1'
        AND handleruserid = #{userid})

        AND NOT EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '0'
        AND handleruserid = #{userid})
        UNION ALL
        SELECT
        a.id,
        a.caseguid,
        a.focus,
        a.serialnum,
        a.tserialnum,
        a.rqsttitle,
        a.accordtype,
        a.labelname,
        a.assigndate,
        a.expiredate,
        a.resulttimemin,
        a.systemsource,
        a.issignin,
        a.signinaccount,
        a.signinname,
        a.signinuserid,
        a.signindeptid,
        a.signdate,
        a.formtype,
        a.operate,
        a.nextnodeid,
        a.state,
        a.updatedate,
        a.isaccept,
        a.senderid,
        a.sdexpirationdate,
        a.worktype,
        d.keyword AS keyword,
        d.linknumber AS tel,
        a.handledeptname,
        a.regdeptname,
        a.registrant,
        a.cwcs,
        a.dubcs,
        a.firstblqx,
        a.blqx,
        a.bustype,
        a.complainant,
        a.isregistercase,
        d.appealsource,
        a.complainanted,
        d.problemdescribe AS content,
        d.servicetype,
        d.complaintstype,
        d.rqstperson,
        d.isweb,
        d.isprofessional,
        d.incomingcommpany,
        a.feedback
        FROM
        tasklist a
        INNER JOIN complaintform d ON d.caseguid = a.caseguid
        WHERE
        EXISTS (
        SELECT
        1
        FROM
        processinfo e
        WHERE
        e.caseguid = a.caseguid
        AND ismain = '1'
        AND STATUS = '1'
        AND handleruserid = #{userid})

        AND NOT EXISTS ( SELECT 1 FROM processinfo e WHERE e.caseguid = a.caseguid AND ismain = '1' AND STATUS = '0' AND handleruserid = #{userid})
        ) t
        <where>
        t.state = '0' and t.systemsource='01'
        <choose>
            <when test="isregisterbegin != null and isregisterbegin != ''">
                 AND t.isregistercase is null AND t.formtype='03'
                <![CDATA[ AND t.sdexpirationdate >= to_timestamp(#{isregisterbegin}, 'yyyy-MM-dd hh24:mi:ss')]]>
                <![CDATA[ AND t.sdexpirationdate <= to_timestamp(#{isregisterend}, 'yyyy-MM-dd hh24:mi:ss')]]>
            </when>
            <when test="feedbackbegin != null and feedbackbegin != ''">
                AND t.feedback is null AND t.formtype!='01'
                <![CDATA[ AND t.sdexpirationdate >= to_timestamp(#{feedbackbegin}, 'yyyy-MM-dd hh24:mi:ss')]]>
                <![CDATA[ AND t.sdexpirationdate <= to_timestamp(#{feedbackend}, 'yyyy-MM-dd hh24:mi:ss')]]>
            </when>
                <when test="finalbackbegin !=null and finalbackbegin !=''">
                    AND t.nextnodeid !='end'
                    <![CDATA[ AND t.sdexpirationdate >= to_timestamp(#{finalbackbegin}, 'yyyy-MM-dd hh24:mi:ss')]]>
                    <![CDATA[ AND t.sdexpirationdate <= to_timestamp(#{finalbackend}, 'yyyy-MM-dd hh24:mi:ss')]]>
                </when>
        </choose>
        </where>
    </select>


</mapper>
